<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Lil Petey's Films+ - Watch movies and shows for free without ads">
  <title>Movie Library</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="stylesheet" href="./style/style.css">
  <link rel="preload" href="./data/movie_data.json" as="fetch" crossorigin>
  <link rel="preload" href="./data/episodes_data.json" as="fetch" crossorigin>
  <link rel="preload" href="./data/comingsoon_data.json" as="fetch" crossorigin>
<body>

  <div id="sidebar-container"></div>

<script src="./utils.js"></script>
  <div class="header-container">
    <div class="header-background" style="background-image: url('https://files.catbox.moe/my2nqu');"></div>
    <div class="header-text">Lil Petey's Films+</div>
  </div>

  <div class="intro-box">
    <pre>Hello and Welcome to Lil Petey's Films+! Here you can watch all movies made by the studio for free and no ads included. Information on other projects will also drop here when new info has released.
  
  Have fun!
  -Lil Petey</pre>
  </div> 
  
  <div class="intro-box" style="width:30rem; font-size: 2rem; background:None;">
    <pre>COMING SOON!!!!</pre>
  </div> 

  <div class="gallery" id="coming-soon-gallery">
    <p style="color: gray;">Loading upcoming releases...</p>
  </div>

  <div class="intro-box" style="width:30rem; font-size: 2rem; background:None;">
    <pre>Episodes</pre>
  </div> 

  <div class="gallery" id="episodes-gallery">
    <p style="color: gray;">Loading episodes...</p>
  </div>

  <div class="intro-box" style="width:30rem; font-size: 2rem; background:None;">
    <pre>Movies</pre>
  </div> 

  <div class="gallery" id="movie-gallery">
    <p style="color: gray;">Loading movies...</p>
  </div>

  <script src="./sidebar.js"></script>
  <script>
    fetch('./sidebar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
      })
      .then(() => {
        initSidebar();
      });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const { getElementById: getElement } = window.utils;

      const createCard = (item, index, page, paramName) => {
        const card = document.createElement('div');
        card.className = 'movie-card';

        if (page) {
          card.onclick = () => {
            window.location.href = `./${page}?${paramName}=${index}`;
          };
        }

        const img = document.createElement('img');
        img.src = item.thumbnail || '';
        img.alt = item.title || '';
        img.loading = 'lazy';
        img.onerror = () => {
          img.src = 'placeholder.jpg';
          img.onerror = null;
        };

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = item.title || 'Untitled';

        card.appendChild(img);
        card.appendChild(title);

        return card;
      };

      const renderGallery = (items, containerId, page, paramName) => {
        const gallery = getElement(containerId);
        if (!gallery) return;

        gallery.innerHTML = '';

        if (!Array.isArray(items) || items.length === 0) {
          gallery.innerHTML = '<p style="opacity: 0.6;">No items available</p>';
          return;
        }

        const fragment = document.createDocumentFragment();

        items.forEach((item, index) => {
          const card = createCard(item, index, page, paramName);

          if (containerId === 'coming-soon-gallery' && item.description) {
            const description = document.createElement('div');
            description.className = 'description';

            const sanitizedDescription = item.description.replace(/[<>&"']/g, (c) => {
              return {
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                '"': '&quot;',
                "'": '&#39;'
              }[c];
            });

            const formattedDescription = sanitizedDescription.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            description.innerHTML = formattedDescription;
            card.appendChild(description);
          }

          fragment.appendChild(card);
        });

        gallery.appendChild(fragment);
      };

      const fetchData = async (url) => {
        try {
          const response = await fetch(url, { cache: 'no-cache' });
          if (!response.ok) throw new Error(`HTTP error ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error(`Error fetching ${url}:`, error);
          throw error;
        }
      };

      try {
        const results = await Promise.allSettled([
          fetchData('./data/movie_data.json'),
          fetchData('./data/comingsoon_data.json'),
          fetchData('./data/episodes_data.json')
        ]);

        const [moviesResult, upcomingResult, episodesResult] = results;

        if (moviesResult.status === 'fulfilled') {
          renderGallery(moviesResult.value, 'movie-gallery', 'movie.html', 'movie');
        } else {
          const gallery = getElement('movie-gallery');
          if (gallery) gallery.innerHTML = '<p style="color: red;">Could not load movie list.</p>';
        }

        if (upcomingResult.status === 'fulfilled') {
          renderGallery(upcomingResult.value, 'coming-soon-gallery', null, null);
        } else {
          const gallery = getElement('coming-soon-gallery');
          if (gallery) gallery.innerHTML = '<p style="color: red;">Could not load upcoming movies.</p>';
        }

        if (episodesResult.status === 'fulfilled') {
          renderGallery(episodesResult.value, 'episodes-gallery', 'episodes.html', 'season');
        } else {
          const gallery = getElement('episodes-gallery');
          if (gallery) gallery.innerHTML = '<p style="color: red;">Could not load episodes.</p>';
        }

      } catch (err) {
        console.error("Failed to load data:", err);
      }
    });
  </script>

</body>
</html>